(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{209:function(a,e,s){"use strict";s.r(e);var r=s(0),t=Object(r.a)({},(function(){var a=this,e=a.$createElement,s=a._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"socket-gatewayworker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#socket-gatewayworker","aria-hidden":"true"}},[a._v("#")]),a._v(" Socket - GatewayWorker")]),a._v(" "),s("div",{staticClass:"tip custom-block"},[s("p",[s("strong",[a._v("特別感謝")]),a._v("  此為 "),s("code",[a._v("rainlay")]),a._v(" 大分享技術筆記, 在此感謝! @https://github.com/rainlay")])]),a._v(" "),s("h2",{attrs:{id:"名詞說明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#名詞說明","aria-hidden":"true"}},[a._v("#")]),a._v(" 名詞說明")]),a._v(" "),s("h3",{attrs:{id:"workerman-gatewayworker-是一套-socket-框架"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#workerman-gatewayworker-是一套-socket-框架","aria-hidden":"true"}},[a._v("#")]),a._v(" "),s("code",[a._v("workerman/gatewayworker")]),a._v(" 是一套 Socket 框架")]),a._v(" "),s("p",[s("a",{attrs:{href:"http://doc2.workerman.net/gateway-worker-separation.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("官方文件"),s("OutboundLink")],1)]),a._v(" "),s("ul",[s("li",[s("code",[a._v("gateway")])]),a._v(" "),s("li",[s("code",[a._v("register")])]),a._v(" "),s("li",[s("code",[a._v("worker")])])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("當初為了維持 HA 以及 Scalable, 台灣的 socket Server 架設的方式為 \nMaster-worker 分散式部屬方式，\nMaster 負責的部分為 gateway, register,\nWorker 的部分則為 Business Worker,因此如果發生系統瓶頸時, \n看是在 gateway的部分或者 worker 的部分 loading 較高，\n即可新增 Master 或 Worker 的機器即可\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("p",[a._v("因TH目前只有作答監控且使用者人數較低的原因，因此 Server 並沒有以分散式架構進行部屬，\n全部服務皆為同一台。")]),a._v(" "),s("h2",{attrs:{id:"socket-server-操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#socket-server-操作","aria-hidden":"true"}},[a._v("#")]),a._v(" Socket Server 操作")]),a._v(" "),s("p",[a._v("這邊只介紹常用的幾個指令")]),a._v(" "),s("h3",{attrs:{id:"啟動"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#啟動","aria-hidden":"true"}},[a._v("#")]),a._v(" 啟動")]),a._v(" "),s("p",[a._v("至專案目錄執行")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" php start.php start -d\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[s("code",[a._v("start")]),a._v(" 就是啟動socket server,並且會顯示 log、以及 error 等資訊，\n適合 debug 使用，"),s("code",[a._v("-d")]),a._v(" 則表示以 daemon 方式啟動,因此正式環境下啟動請務必加上 "),s("code",[a._v("-d")]),a._v("。")]),a._v(" "),s("h3",{attrs:{id:"重載-reload"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重載-reload","aria-hidden":"true"}},[a._v("#")]),a._v(" 重載 Reload")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" php start.php reload\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("reload 會讓 socket 重新讀取程式碼，但不會中斷服務，因此非常適合新功能上線時使用。")]),a._v(" "),s("h3",{attrs:{id:"重啟"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重啟","aria-hidden":"true"}},[a._v("#")]),a._v(" 重啟")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" php start.php restart\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h3",{attrs:{id:"查看-socket-狀態"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看-socket-狀態","aria-hidden":"true"}},[a._v("#")]),a._v(" 查看 socket 狀態")]),a._v(" "),s("p",[a._v("狀態的說明可參考"),s("a",{attrs:{href:"http://doc.workerman.net/315185",target:"_blank",rel:"noopener noreferrer"}},[a._v("官方文件"),s("OutboundLink")],1)]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" php start.php status\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h2",{attrs:{id:"專案架構"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#專案架構","aria-hidden":"true"}},[a._v("#")]),a._v(" 專案架構")]),a._v(" "),s("h3",{attrs:{id:"companyconfig-php"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#companyconfig-php","aria-hidden":"true"}},[a._v("#")]),a._v(" COMPANYConfig.php")]),a._v(" "),s("p",[a._v("專案目錄有以下設定檔案:")]),a._v(" "),s("ul",[s("li",[a._v("ConfigDev.php")]),a._v(" "),s("li",[a._v("ConfigLocal.php")]),a._v(" "),s("li",[a._v("ConfigTesting.php")]),a._v(" "),s("li",[a._v("ConfigMaster.php")]),a._v(" "),s("li",[a._v("ConfigWorkerOne.php")])]),a._v(" "),s("p",[a._v("基本上這些 Config 會在部屬時因為不同的環境而去轉換成 COMPANYConfig.php\nex: websocket-master 的 COMPANYConfig 等於 ConfigMaster.php\nwebsocket-worker1 的 COMPANYConfig 等於 ConfigWorkerOne.php")]),a._v(" "),s("p",[a._v("裡面的 Config 參數決定了 Socket Server 如何啟動")]),a._v(" "),s("h4",{attrs:{id:"參數說明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#參數說明","aria-hidden":"true"}},[a._v("#")]),a._v(" 參數說明")]),a._v(" "),s("h5",{attrs:{id:"machinetype"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#machinetype","aria-hidden":"true"}},[a._v("#")]),a._v(" $machineType")]),a._v(" "),s("p",[a._v("以什麼服務啟動 ex: Register/Gateway, BusinessWorker，像 master 的機器就是 Register/Gateway, worker 機器則是 BusinessWorker，測試機或本地環境則是 All。")]),a._v(" "),s("h5",{attrs:{id:"lanip"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lanip","aria-hidden":"true"}},[a._v("#")]),a._v(" $lanIp")]),a._v(" "),s("p",[a._v("該 server 的內網 IP，非分散式部屬通常就是 127.0.0.1")]),a._v(" "),s("h5",{attrs:{id:"registeraddress"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#registeraddress","aria-hidden":"true"}},[a._v("#")]),a._v(" $registerAddress")]),a._v(" "),s("p",[a._v("register 的 server ip, 例如 worker的config 必須指到 master 機器的 ip, 否則會設定錯誤。")]),a._v(" "),s("h5",{attrs:{id:"stagemode"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#stagemode","aria-hidden":"true"}},[a._v("#")]),a._v(" $stageMode")]),a._v(" "),s("p",[a._v("stageMode 主要是用在給程式判斷是否要開啟 wss 所使用(start_gateway.php)。")]),a._v(" "),s("h3",{attrs:{id:"泰國-socket-db-連線資訊"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#泰國-socket-db-連線資訊","aria-hidden":"true"}},[a._v("#")]),a._v(" 泰國 Socket DB 連線資訊")]),a._v(" "),s("p",[a._v("台灣的 Socket 目前並不直接連線 Database, 故跳過。")]),a._v(" "),s("h4",{attrs:{id:"dotenv"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dotenv","aria-hidden":"true"}},[a._v("#")]),a._v(" dotenv")]),a._v(" "),s("p",[a._v("鑑於保護敏感資訊，有別於較的專案，泰國 Socket 這邊導入了 env file"),s("a",{attrs:{href:"https://github.com/vlucas/phpdotenv",target:"_blank",rel:"noopener noreferrer"}},[a._v("(phpdotenv)"),s("OutboundLink")],1),a._v(" 機制，將敏感資訊如 DB, Firebase token等類型資訊以 .env file 方式儲存，所以此 env file 不會存在 git 裡面，在開發以及部署正式環境時記得手動設定檔案。")]),a._v(" "),s("p",[a._v("檔案路徑:")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("/home/ubuntu/PROJECT/Applications/PROJECTApp/project_app.env\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("範例檔案路徑:")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("/home/ubuntu/PROJECT/Applications/PROJECTApp/project_app_example.env\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h2",{attrs:{id:"程式部屬"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#程式部屬","aria-hidden":"true"}},[a._v("#")]),a._v(" 程式部屬")]),a._v(" "),s("p",[a._v("部屬可以用兩個方式")]),a._v(" "),s("h3",{attrs:{id:"一般方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一般方式","aria-hidden":"true"}},[a._v("#")]),a._v(" 一般方式")]),a._v(" "),s("p",[a._v("ssh 至 socket 主機，至專案目錄執行")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 更新程式碼")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" pull origin master\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 讓 workerman reload 程式碼")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" php start.php reload\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[a._v("手動部屬須注意的是 Master, Worker 等不同主機都需上去手動執行，如果以後有相關 Config 調整，必須記得手動處理。")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("dep deploy production\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("即可自動部屬程式碼，不管是 Master, Worker 的 config, Workerman 的 reload,等繁雜設定皆可自動完成。")])])}),[],!1,null,null,null);e.default=t.exports}}]);