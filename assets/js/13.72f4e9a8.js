(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{212:function(a,e,s){"use strict";s.r(e);var t=s(0),l=Object(t.a)({},(function(){var a=this,e=a.$createElement,s=a._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"ansible"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ansible","aria-hidden":"true"}},[a._v("#")]),a._v(" Ansible")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("PS")]),a._v(" : 文檔內的 "),s("code",[a._v("vg")]),a._v(" 均表示 "),s("code",[a._v("vagrant")]),a._v(" (因有Alias設定)")]),a._v(" "),s("li",[a._v("設定參考 "),s("code",[a._v("mouworks/ansibleStack")])])]),a._v(" "),s("h3",{attrs:{id:"定義"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#定義","aria-hidden":"true"}},[a._v("#")]),a._v(" 定義:")]),a._v(" "),s("ul",[s("li",[a._v("推式更新 (pushed based, 要安裝的電腦不需要額外設定)")])]),a._v(" "),s("h3",{attrs:{id:"本機電腦安裝-ansible"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#本機電腦安裝-ansible","aria-hidden":"true"}},[a._v("#")]),a._v(" 本機電腦安裝 Ansible")]),a._v(" "),s("ul",[s("li",[a._v("需要 Python "),s("code",[a._v("sudo pip install ansible")])])]),a._v(" "),s("h3",{attrs:{id:"ansible-的組態檔案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ansible-的組態檔案","aria-hidden":"true"}},[a._v("#")]),a._v(" Ansible 的組態檔案")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("├── Makefile\n└── playbooks\n    ├── Makefile\n    ├── Vagrantfile\n    ├── ansible.cfg\n    ├── build_infra.yml\n    ├── files\n    │   ├── nginx.conf\n    │   ├── nginx.crt\n    │   └── nginx.key\n    ├── hosts\n    ├── init_DO_server.yml\n    ├── templates\n    │   ├── index.html.j2\n    │   └── nginx.conf.j2\n    ├── web-notls.yml\n    └── web-tls.yml\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br")])]),s("ul",[s("li",[s("code",[a._v("ansible.cfg")]),a._v(" -> Ansible組態檔的位置")]),a._v(" "),s("li",[s("code",[a._v("hosts")]),a._v(" -> 機器的設定（主要設定機器IP, Key的位置)")]),a._v(" "),s("li",[s("code",[a._v("playbook")]),a._v(" -> 設定的腳本 (要安裝什麼, 安裝的順序等等)\n"),s("ul",[s("li",[s("code",[a._v("web-notls.yml")]),a._v(" -> 無設定 TLS 的 Nginx YML")]),a._v(" "),s("li",[s("code",[a._v("web-tls.yml")]),a._v(" -> 有設定 TLS")])])])]),a._v(" "),s("h3",{attrs:{id:"ansible-如何控制機器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ansible-如何控制機器","aria-hidden":"true"}},[a._v("#")]),a._v(" Ansible 如何控制機器")]),a._v(" "),s("ul",[s("li",[a._v("均由 SSH 來處理")]),a._v(" "),s("li",[a._v("Local Vagrant 需要再額外設定")])]),a._v(" "),s("h4",{attrs:{id:"steps-執行步驟"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#steps-執行步驟","aria-hidden":"true"}},[a._v("#")]),a._v(" Steps 執行步驟")]),a._v(" "),s("ul",[s("li",[s("p",[a._v("PS, 如果 init 或者 vg up 不順, 升級 && 更新 Vagrant 和 VirtualBox")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("mkdir playbooks && cd playbooks\nvg init ubunutu/trusty64 && vg up\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])])]),a._v(" "),s("li",[s("p",[a._v("程式說明")]),a._v(" "),s("ol",[s("li",[a._v("專案 folder 建立一個 "),s("code",[a._v("playbook")]),a._v(" folder")]),a._v(" "),s("li",[a._v("Vg init 一個標準 ubuntu image")]),a._v(" "),s("li",[a._v("Vg up")])])]),a._v(" "),s("li",[s("p",[a._v("看 Vagrant 的 SSH Config 訊息")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("vg ssh-config\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])])]),a._v(" "),s("li",[s("p",[a._v("將IP, keyfile 寫成 "),s("code",[a._v("hosts")]),a._v(" 檔案")])]),a._v(" "),s("li",[s("p",[s("code",[a._v("hosts")]),a._v(" -> IP, Keyfile 以及username")]),a._v(" "),s("ul",[s("li",[a._v("可存放在 "),s("code",[a._v("/etc/ansible/")]),a._v(" -> 但這是本機檔案, 較不建議")]),a._v(" "),s("li",[a._v("或者可放在 Repo底下 (建議做法, Config as code)")])])]),a._v(" "),s("li",[s("p",[a._v("Ansible 下指令的語法")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("ansible testserver -m ping")]),a._v(" -> 去Ping看看Server")]),a._v(" "),s("li",[s("code",[a._v("ansible testserver -m command -a uptime")]),a._v(" -> 看機器起來了多久")]),a._v(" "),s("li",[s("code",[a._v("ansible testserver -a uptime")]),a._v(" -> 同上, 預設模組的指令")]),a._v(" "),s("li",[s("code",[a._v('ansible testserver -a "tail /var/log/dmesg"')]),a._v(" -> 去看特定log")])])]),a._v(" "),s("li",[s("p",[a._v("需要 Root 的情境: 使用 "),s("code",[a._v("-b")])]),a._v(" "),s("ul",[s("li",[s("code",[a._v('ansible testserver -b -a "tail /var/log/syslog"')]),a._v(" -> 去看系統log, 需要root權限")])])]),a._v(" "),s("li",[s("p",[a._v("例如安裝 "),s("code",[a._v("nginx")])]),a._v(" "),s("ul",[s("li",[s("code",[a._v("ansible testserver -b -m apt -a name=nginx")])])])]),a._v(" "),s("li",[s("p",[s("code",[a._v("DigitalOcean")]),a._v(" 需要用 "),s("code",[a._v("root")]),a._v(" 登入以及操作:")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("ansible production -m ping -u root")]),a._v(" (後方加上 "),s("code",[a._v("-u root")]),a._v(")")]),a._v(" "),s("li",[a._v("或者在 ansible 的 "),s("code",[a._v("host")]),a._v(" 檔案內加上 "),s("code",[a._v("ansible_ssh_user=root")])])])])]),a._v(" "),s("h5",{attrs:{id:"修改-vagrant-設定讓ansible可以溝通"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改-vagrant-設定讓ansible可以溝通","aria-hidden":"true"}},[a._v("#")]),a._v(" 修改 Vagrant 設定讓ansible可以溝通")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("Vagrantfile")]),a._v(" 內加上這個設定"),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('  config.vm.network "forwarded_port", guest: 80, host: 8082\n  config.vm.network "forwarded_port", guest: 443, host: 8443\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])])]),a._v(" "),s("li",[a._v("Vagrant Reload "),s("code",[a._v("vg reload")])])]),a._v(" "),s("h5",{attrs:{id:"寫第一個-playbook"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#寫第一個-playbook","aria-hidden":"true"}},[a._v("#")]),a._v(" 寫第一個 playbook")]),a._v(" "),s("ul",[s("li",[s("p",[s("code",[a._v("web-notls.yml")]),a._v(" -> 寫一個安裝 nginx 的 playbook")])]),a._v(" "),s("li",[s("p",[a._v("如何下指令")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("  ansible-playbook web-notls.yml\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])])]),a._v(" "),s("li",[s("p",[a._v("Ansible 特性: 會紀錄做過哪些事情, 故 安裝 nginx 如果已經裝過, 且有紀錄, 則下次只會顯示 ok, 表示跳過該 step")])])]),a._v(" "),s("h5",{attrs:{id:"第二個-playbook-web-with-tls"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#第二個-playbook-web-with-tls","aria-hidden":"true"}},[a._v("#")]),a._v(" 第二個 playbook: web with TLS")]),a._v(" "),s("ul",[s("li",[s("p",[a._v("自己產Key")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -subj /CN=localhost -keyout files/nginx.key -out files/nginx.crt\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])])]),a._v(" "),s("li",[s("p",[s("code",[a._v("web-tls.yml")]),a._v(" -> 有 SSL 的 Nginx 設定")])]),a._v(" "),s("li",[s("p",[a._v("ansible 使用 "),s("code",[a._v("jinja2")]),a._v(" 模板, 類似 mustache")])])]),a._v(" "),s("h5",{attrs:{id:"主要由一個-yml-將步驟寫好"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主要由一個-yml-將步驟寫好","aria-hidden":"true"}},[a._v("#")]),a._v(" 主要由一個 .yml 將步驟寫好")]),a._v(" "),s("h5",{attrs:{id:"雙機流設定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#雙機流設定","aria-hidden":"true"}},[a._v("#")]),a._v(" 雙機流設定")]),a._v(" "),s("ul",[s("li",[s("p",[a._v("設定兩台機器")]),a._v(" "),s("ul",[s("li",[a._v("一台 Vagrant (本機快速開發測)")]),a._v(" "),s("li",[a._v("一台 DO (遠端機器)")])])]),a._v(" "),s("li",[s("p",[a._v("Vagrant 機 -> Host 設定名為 "),s("code",[a._v("local")])])]),a._v(" "),s("li",[s("p",[a._v("DO 機 -> Host 設定名為 "),s("code",[a._v("production")])])]),a._v(" "),s("li",[s("p",[a._v("當 script 要單獨跑的時候, host 指定 "),s("code",[a._v("local")]),a._v(" 或是 "),s("code",[a._v("production")])])]),a._v(" "),s("li",[s("p",[a._v("當 都要跑的時候, 設定 "),s("code",[a._v("all")]),a._v(" -> 兩者都跑")])]),a._v(" "),s("li",[s("p",[a._v("如 "),s("code",[a._v("ans-init-DO")]),a._v(" 為 DigitalOcean 設定機器的資訊, 故 local 不需要跑")])])])])}),[],!1,null,null,null);e.default=l.exports}}]);